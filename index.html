<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>牙科券查詢</title>
    </head>
<body>
    <form id="myForm">
        <label for="id">ID:</label>
        <input type="text" id="id" name="id" required><br><br>

        <label for="passwd">密碼:</label>
        <input type="password" id="passwd" name="passwd" required><br><br>

        <label for="exam">考試:</label>
        <select id="exam" name="exam">
            <option value="">載入中...</option>
        </select><br><br>

        <button type="submit">送出</button>
    </form>
    <div id="result"></div>

    <script>
        // 你的 Google Apps Script Web App URL
        // 請確保這是你最新部署的、權限設定為「任何人」的 URL
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyQiqBnM-qdnCbca-jvBPQG8KYxEhaFHynx0jyB7GdgCL9Xj48EyHvo-4UBPLSRpiu9/exec';

        // 函式：載入試卷列表
        async function loadExamList() {
            const examSelect = document.getElementById('exam');
            try {
                // 使用 GET 請求獲取 sheet names
                const response = await fetch(`${GAS_WEB_APP_URL}?action=getallsheetnames`);

                if (!response.ok) {
                    throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                examSelect.innerHTML = ''; // 清空現有選項
                data.sheetNames.forEach(sheetName => {
                    const option = document.createElement('option');
                    option.value = sheetName;
                    option.textContent = sheetName;
                    examSelect.appendChild(option);
                });
            } catch (error) {
                console.error('無法載入試卷列表:', error);
                examSelect.innerHTML = '<option value="">載入失敗</option>';
                alert('無法載入試卷列表: ' + error.message);
            }
        }

        // 函式：處理表單提交
        async function processFormSubmission(event) {
            event.preventDefault(); // 阻止表單預設提交行為

            const id = document.getElementById('id').value;
            const passwd = document.getElementById('passwd').value;
            const exam = document.getElementById('exam').value;

            const formData = {
                action: 'processForm', // 指定要執行的 Apps Script 動作
                id: id,
                passwd: passwd,
                exam: exam
            };

            const resultDiv = document.getElementById('result');
            resultDiv.textContent = '提交中...';

            try {
                // *** 這裡是你需要修改的地方 ***
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        // 關鍵修改：使用 text/plain;charset=utf-8
                        'Content-Type': 'text/plain;charset=utf-8', 
                    },
                    // 將物件轉換為 JSON 字串作為請求體
                    body: JSON.stringify(formData),
                });

                if (!response.ok) {
                    throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    resultDiv.textContent = '錯誤: ' + data.error;
                } else {
                    resultDiv.textContent = '提交成功: ' + JSON.stringify(data);
                    // 根據實際的 Apps Script 回傳結果顯示
                }
            } catch (error) {
                console.error('表單提交失敗:', error);
                resultDiv.textContent = '提交失敗: ' + error.message;
                alert('表單提交失敗: ' + error.message);
            }
        }

        // 當 DOM 內容載入完畢後執行
        document.addEventListener('DOMContentLoaded', () => {
            loadExamList(); // 載入試卷列表
            const form = document.getElementById('myForm');
            form.addEventListener('submit', processFormSubmission); // 綁定表單提交事件
        });
    </script>
</body>
</html>
