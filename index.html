<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>牙材券查詢系統</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', 'Noto Sans TC', sans-serif;
        line-height: 1.8;
        background-color: #f3f4f6;
        font-size: 1.5rem;
        background-image: linear-gradient(rgba(255,255,255,0.6), rgba(255,255,255,0.6)),
          url('https://ymdd-image-tw.s3.ap-east-2.amazonaws.com/file_00000000934461f78931c0c083eafdc7.png');
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center top;
        background-attachment: scroll;
      }

      @media (min-width: 768px) {
        html, body {
          font-size: 1rem;
          background-image: linear-gradient(rgba(255,255,255,0.6), rgba(255,255,255,0.6)),
            url('https://ymdd-image-tw.s3.ap-east-2.amazonaws.com/photo_2025-07-25_22-19-42.jpg');
        }
      }

      .container {
        max-width: 768px;
        margin: 0 auto;
        padding: 2rem;
      }

      .card {
        background-color: #ffffff;
        padding: 1.5rem;
        border-radius: 1.25rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
        border: 1px solid #e5e7eb;
      }

      .field-label {
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 0.5rem;
        font-size: 1.6rem;
      }

      .field-value {
        color: #111827;
        margin-bottom: 1rem;
        font-size: 2rem;
        word-break: break-word;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h2>牙材券查詢系統</h2>
        <form id="loginForm">
          <label class="field-label">姓名：</label><br />
          <input type="text" name="id" required style="width: 100%; padding: 0.5rem; font-size: 1rem;" /><br /><br />

          <label class="field-label">密碼：</label><br />
          <input type="password" name="passwd" required style="width: 100%; padding: 0.5rem; font-size: 1rem;" /><br /><br />

          <label class="field-label">查詢：</label><br />
          <select name="exam" id="examSelect" style="width: 100%; padding: 0.5rem; font-size: 1rem;"></select><br /><br />

          <button type="submit" style="padding: 0.75rem 1.5rem; font-size: 1rem; border: none; background-color: #3b82f6; color: white; border-radius: 0.5rem;">查詢</button>
        </form>
      </div>

      <div id="result"></div>
    </div>

    <script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbznjcpSSRw_fNSuXYNX3et2HkTemxgNE9LIERbFAEwNYuJBWxNAEZ3IElCD75VpQ4P8/exec";
  
  document.addEventListener("DOMContentLoaded", function () {
    const select = document.getElementById("examSelect");
    const loginForm = document.getElementById("loginForm");
    const resultDiv = document.getElementById("result");
    const submitButton = loginForm.querySelector('button[type="submit"]');

    // 載入試卷列表
   fetch(GAS_URL + "?action=getallsheetnames") // 第一個請求：獲取試算表名稱
  .then(res => res.json())
  .then(data => {
    if (Array.isArray(data)) {
      data.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        // 假設 `select` 是一個已經存在的 DOM 元素，例如 <select id="mySelect"></select>
        // 如果 `select` 未定義，您需要先獲取它，例如：
        // const select = document.getElementById("mySelect");
        select.appendChild(opt);
      });
    }

    // --- 在這裡加入您的第二個 fetch (POST) 請求 ---
    // 您的 POST 請求的 DATA，請替換為實際的資料
    const DATA_FOR_POST = {
      action: "submitData", // 假設您的 GAS 服務會根據 action 參數處理不同的請求
      someKey: "someValue",
      anotherKey: "anotherValue"
    };

    return fetch(GAS_URL, { // 注意這裡只用 GAS_URL，因為您說 URL 就是 GAS_URL
      redirect: "follow",
      method: "POST",
      body: JSON.stringify(DATA_FOR_POST),
      headers: {
        "Content-Type": "text/plain;charset=utf-8", // GAS 通常建議使用 text/plain
      },
    })
    .then(postRes => postRes.json()) // 假設 POST 請求也會返回 JSON 響應
    .then(postData => {
      console.log("POST 請求成功，GAS 返回資料:", postData);
      // 您可以在這裡處理 POST 請求的成功響應，例如顯示成功訊息
      alert("資料已成功提交！");
    })
    .catch(postErr => {
      console.error("POST 請求失敗:", postErr);
      alert("資料提交失敗，請檢查網路連線或聯繫管理員。");
    });
    // --- 結束第二個 fetch 請求 ---

  })
  .catch(err => {
    // 這個 catch 會捕獲第一個 fetch 或第二個 fetch 中發生的任何錯誤
    console.error("操作失敗 (獲取試卷列表或提交資料):", err);
    alert("操作失敗，請檢查網路連線或聯繫管理員。");
  });

    // 監聽表單提交
    loginForm.addEventListener("submit", function (e) {
      e.preventDefault();
      submitButton.disabled = true; // 防止重複提交
      resultDiv.innerHTML = '<div class="card">查詢中...</div>';

      const formData = new FormData(this);
      const params = new URLSearchParams(formData);
      params.append("action", "processForm");

      fetch(GAS_URL, {
        method: "POST",
        body: params
      })
      .then(res => {
          if (!res.ok) {
              throw new Error(`伺服器錯誤: ${res.status}`);
          }
          return res.json();
      })
      .then(result => {
        resultDiv.innerHTML = ''; // 清空結果區
        
        // 檢查回傳結果是否有錯誤，或紀錄是否為空
        if (result.error || !result.record || result.record.length === 0) {
          const errorMessage = result.error ? `錯誤：${result.error}` : '無紀錄或密碼錯誤';
          resultDiv.innerHTML = `<div class="card">❌ ${errorMessage}</div>`;
          return;
        }

        const titleRow = result.title;
        const records = result.record;
        records.forEach(row => {
          let html = '<div class="card">';
          for (let i = 0; i < titleRow.length; i++) {
            html += '<div><span class="field-label">' + titleRow[i] + '：</span>';
            html += '<span class="field-value">' + (row[i] || '-') + '</span></div>';
          }
          html += '</div>';
          resultDiv.innerHTML += html;
        });
      })
      .catch(err => {
          console.error("查詢失敗:", err);
          resultDiv.innerHTML = `<div class="card">❌ 查詢失敗，請檢查瀏覽器主控台(F12)的錯誤訊息。</div>`;
      })
      .finally(() => {
          submitButton.disabled = false; // 無論成功失敗，都恢復按鈕功能
      });
    });
  });
</script>
  </body>
</html>
